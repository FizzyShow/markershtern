# Context: 
Микросервис отвечающий за аутентификацию и авторизацию пользователя
# Status
Предложено
# Decision
### Данный в БД хранятся следующим образом: 
    string user_Id
    string login
    string hash
    string salt
### Proto: 
    service AuthService{
        rpc Login(LoginRequest) returns (LoginResponse);
        rpc TokenValidate(TokenValidateRequst) returns(TokenValidateResponse);
    }

    message LoginRequest {
        string login = 1;
        string password = 2;
    }

    message LoginResponse {
        oneof result{
            string error = 1;
            string token = 2;
        }
    }
    
При получении LoginRequest микросервис сравнивает вложенные в него данные с теми, что хранятся в БД.
* Если пользователя с указанным логином не существует, то в LoginResponse отправляем соответствующую ошибку.
* Если пользователь с указанным логином существует, то вычисляем хэш пароля с солью (которая указана в БД) и сравниваем его со значением хэша в БД:
* - Если хэш не совпадает, то в LoginResponse отправляем соответствующую ошибку
* - Иначе в LoginResponse отправляем сгенерированный временный токен (JWT)  
* Если пользователей с указанным логином больше одного, то перебираем каждого из них.
* - Если ни один из хешей не совпал, то в LoginResponse отправляем соответствующую ошибку
* - Иначе в LoginResponse отправляем сгенерированный временный токен (JWT)
*

    message TokenValidateRequest {
        string token = 1;
    }

    message TokenValidateResponse {
        oneof result{
            string error = 1;
            string userId = 2;
        }
    } 

При получении TokenValidateRequest микросервис производит валидацию токена.
* Если токен корректен, то в TokenValidateResponse отправляется userId.
* Иначе в TokenValidateResponse отправляется соответствующая ошибка.
*

    message UserRegisterRequstedEvent {
        string login = 1;
        string password = 2;
    } 

Микросервис подписан на событие UserRegisterRequstedEvent в кафке, при его получении указанные данные пользователя заносятся в БД.  
Вместо пароля в БД добавляется его хэш с применением соли.  
После занесения информации в БД микросервис отправляет в определенный топик кафки событие UserRegisteredEvent, в котором передаётся userId.

### Проблема: 
Получение пользователем отчета о проведении регистрации.  

Пути решения:  
1. Фасад после отправки события на регистрацию в определенный топик кафки посылает LoginRequest с какой-нибудь периодичностью. 
   - Если за установленное максимальное время не будет положительного ответа, то фасад уведомляем пользователя об ошибке регистрации.
   - Иначе, при получении положительного ответа уведомляем пользователя об успешной регистрации.
2. Фасад при отправке события на регистрацию в определенный топик кафки генерирует и указывает в этом событии идентификатор сессии. После отправки фасад подписывается на топик с событиями совершенных регистраций (либо же он с самого начала подписан на этот топик). Микросервис авторизации после совершения регистрации отправляет в этот топик событие UserRegisteredEvent, в котором передаётся userId и идентификатор сессии. В результате, фасад, зная идентификатор сессии, сможет определить удалась ли регистрация нужного пользователя.
